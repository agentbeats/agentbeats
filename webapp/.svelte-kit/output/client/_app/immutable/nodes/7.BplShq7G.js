import"../chunks/CWj6FrbW.js";import{i as It}from"../chunks/_pPX3X5k.js";import{o as Nt,a as zt}from"../chunks/B-G1-8zH.js";import{p as Ot,j as k,m as O,l as gt,d as N,i as e,a as d,b as Et,f as g,n as At,t as jt,s as m,c as l,r as i,k as et,q as B,x as v,aU as M,b0 as Gt}from"../chunks/D_E79TID.js";import{i as D,s as Ht,a as Rt}from"../chunks/D0mllNP8.js";import{e as Tt,i as Kt}from"../chunks/CqRAOBwW.js";import{p as Bt}from"../chunks/gMceMjmh.js";import{g as R}from"../chunks/BXNnu7_f.js";import{C as Qt,B as Xt}from"../chunks/LS3N8AaQ.js";import{s as Yt}from"../chunks/eloSdJH1.js";import{s as te}from"../chunks/BMrKUOY7.js";import{C as kt,a as Pt,b as St,c as Ct}from"../chunks/B6GxE72l.js";import"../chunks/tc0rB4gA.js";import{s as ee,u as re,l as ae}from"../chunks/CRPrjd5f.js";const se=async({fetch:P})=>{try{return{battles:await(await P("/api/battles")).json()}}catch(p){return console.error("Failed to fetch battles:",p),{battles:[]}}},Re=Object.freeze(Object.defineProperty({__proto__:null,load:se},Symbol.toStringTag,{value:"Module"}));var ne=g('<div class="animate-pulse text-muted-foreground">Please waitâ€¦</div>'),oe=g("<!> <!>",1),ie=g('<div class="text-destructive"> </div>'),le=g("<!> <!>",1),de=g('<span><span class="text-xs text-muted-foreground"> </span> <span class="text-xs text-muted-foreground"> </span></span>'),ce=g('<span class="text-xs text-muted-foreground"> </span>'),ue=g('<li class="flex flex-col gap-0.5"><!></li>'),fe=g('<div class="mt-3"><span class="text-xs text-muted-foreground">Opponents:</span> <ul class="ml-4 mt-2 list-disc space-y-1"></ul></div>'),_e=g('<div class="mt-2"><span class="text-xs text-muted-foreground">Opponents: Loading...</span></div>'),ve=g('<div class="mt-2"><span class="text-xs text-muted-foreground">No opponents found</span></div>'),pe=g('<div class="flex flex-row items-center justify-between w-full gap-1 mt-3"><div class="flex flex-col items-start gap-2"><span class="font-bold text-sm"> </span> <span class="text-xs text-muted-foreground font-mono select-all"> </span> <span class="text-xs text-muted-foreground">Host / Green Agent</span> <!></div> <div class="flex flex-col items-end gap-1"><span class="text-xs font-mono text-muted-foreground select-all"> </span> <span class="text-xs text-muted-foreground"> </span> <span class="text-xs text-muted-foreground italic"> </span></div></div>'),ge=g('<span class="text-xs text-muted-foreground"> </span>'),me=g('<div class="flex flex-row items-center gap-3"><span> </span> <span class="text-xs text-muted-foreground"> </span> <!></div> <span class="text-[10px] text-muted-foreground font-mono select-all"> </span>',1),xe=g("<!> <!>",1);function he(P,p){Ot(p,!1);let r=Bt(p,"battle",12,null),dt=Bt(p,"battleId",8,null),K=O(!1),rt=O(null),A=O(""),C=O([]),U=O("");Nt(async()=>{await $()});async function W(t){var a,u,w,s;try{const n=await fetch(`/api/agents/${t}`);if(!n.ok)return t;const o=await n.json();return((a=o.register_info)==null?void 0:a.name)||((u=o.registerInfo)==null?void 0:u.name)||((w=o.agent_card)==null?void 0:w.name)||((s=o.agentCard)==null?void 0:s.name)||t}catch{return t}}async function $(){var t;if(!r()&&dt()){k(K,!0),k(rt,null);try{const a=await fetch(`/api/battles/${dt()}`);if(!a.ok)throw new Error("Failed to fetch battle");r(await a.json())}catch(a){k(rt,a instanceof Error?a.message:"Failed to load battle"),k(K,!1);return}finally{k(K,!1)}}if(r()){(r().green_agent_id||r().greenAgentId)&&k(A,await W(r().green_agent_id||r().greenAgentId));let a=[];if(r().opponents&&Array.isArray(r().opponents))for(const u of r().opponents)if(u&&typeof u=="object"&&u.agent_id){const w=await W(u.agent_id);a.push(`${w} (${u.name||"Unknown Role"})`)}else typeof u=="string"?a.push(await W(u)):a.push("Unknown");if(k(C,a),r().created_at&&((t=r().result)!=null&&t.finish_time)){const u=new Date(r().created_at),w=new Date(r().result.finish_time);if(!isNaN(u.getTime())&&!isNaN(w.getTime())){const s=Math.round((w.getTime()-u.getTime())/1e3);k(U,s<0?"err":s+"s")}else k(U,"")}}}function T(t){return t?t.slice(0,8):""}function F(t){if(!t)return"";let a=t;t&&!t.endsWith("Z")&&(a=t+"Z");const u=Date.now(),w=new Date(a).getTime(),s=Math.floor((u-w)/1e3);if(s<0){const n=Math.abs(s);return n<60?`in ${n}s`:n<3600?`in ${Math.floor(n/60)}m`:n<86400?`in ${Math.floor(n/3600)}h`:`in ${Math.floor(n/86400)}d`}return s<60?`${s}s ago`:s<3600?`${Math.floor(s/60)}m ago`:s<86400?`${Math.floor(s/3600)}h ago`:`${Math.floor(s/86400)}d ago`}function q(t){var u;let a="";return(u=t==null?void 0:t.result)!=null&&u.finish_time?a=t.result.finish_time:(t!=null&&t.created_at||t!=null&&t.createdAt)&&(a=t.created_at||t.createdAt),a&&!a.endsWith("Z")&&(a=a+"Z"),a?new Date(a).toLocaleString():""}function ct(t){var a;return((a=t==null?void 0:t.result)==null?void 0:a.finish_time)||(t==null?void 0:t.created_at)||(t==null?void 0:t.createdAt)||""}function at(t){switch((t||"").toLowerCase()){case"pending":return"text-yellow-600";case"queued":return"text-yellow-600";case"running":return"text-blue-600";case"finished":return"text-green-600";case"error":return"text-red-600";default:return"text-muted-foreground"}}function mt(t){var a,u;return((a=t==null?void 0:t.result)==null?void 0:a.winner)==="draw"?"Draw":(u=t==null?void 0:t.result)!=null&&u.winner?`${t.result.winner} Victory`:(t==null?void 0:t.state)==="error"?t!=null&&t.error?`Error: ${t.error}`:"Error":""}function Q(t){const a=t.match(/^(.*?) \((.*?)\)$/);return a?[a[1],a[2]]:null}It();var st=gt(),ut=N(st);{var ft=t=>{kt(t,{class:"w-full max-w-4xl border shadow-sm bg-background my-2",children:(a,u)=>{var w=oe(),s=N(w);Pt(s,{children:(o,f)=>{St(o,{children:(h,y)=>{At();var _=jt("Loading battle...");d(h,_)},$$slots:{default:!0}})},$$slots:{default:!0}});var n=m(s,2);Ct(n,{children:(o,f)=>{var h=ne();d(o,h)},$$slots:{default:!0}}),d(a,w)},$$slots:{default:!0}})},xt=t=>{var a=gt(),u=N(a);{var w=n=>{kt(n,{class:"w-full max-w-4xl border shadow-sm bg-background my-2",children:(o,f)=>{var h=le(),y=N(h);Pt(y,{children:(c,x)=>{St(c,{children:(b,_t)=>{At();var nt=jt("Error loading battle");d(b,nt)},$$slots:{default:!0}})},$$slots:{default:!0}});var _=m(y,2);Ct(_,{children:(c,x)=>{var b=ie(),_t=l(b,!0);i(b),et(()=>B(_t,e(rt))),d(c,b)},$$slots:{default:!0}}),d(o,h)},$$slots:{default:!0}})},s=n=>{var o=gt(),f=N(o);{var h=y=>{kt(y,{class:"w-full max-w-4xl border shadow-sm bg-background my-4 px-6 py-4",children:(_,c)=>{var x=xe(),b=N(x);Pt(b,{class:"pb-2 px-2",children:(nt,Lt)=>{var X=pe(),V=l(X),E=l(V),ht=l(E,!0);i(E);var J=m(E,2),wt=l(J,!0);i(J);var yt=m(J,4);{var bt=L=>{var Z=fe(),Y=m(l(Z),2);Tt(Y,5,()=>e(C),Kt,($t,I)=>{var S=ue(),it=l(S);{var Wt=tt=>{var G=de(),lt=l(G),qt=l(lt,!0);i(lt);var Mt=m(lt,2),Vt=l(Mt);i(Mt),i(G),et((H,Jt)=>{B(qt,H),B(Vt,`(${Jt??""})`)},[()=>(e(I),v(()=>{var H;return(H=Q(e(I)))==null?void 0:H[0]})),()=>(e(I),v(()=>{var H;return(H=Q(e(I)))==null?void 0:H[1]}))]),d(tt,G)},Ft=tt=>{var G=ce(),lt=l(G,!0);i(G),et(()=>B(lt,e(I))),d(tt,G)};D(it,tt=>{e(I),v(()=>Q(e(I)))?tt(Wt):tt(Ft,!1)})}i(S),d($t,S)}),i(Y),i(Z),d(L,Z)},vt=L=>{var Z=gt(),Y=N(Z);{var $t=S=>{var it=_e();d(S,it)},I=S=>{var it=ve();d(S,it)};D(Y,S=>{M(r()),v(()=>r().opponents&&r().opponents.length>0)?S($t):S(I,!1)},!0)}d(L,Z)};D(yt,L=>{e(C),v(()=>e(C).length>0)?L(bt):L(vt,!1)})}i(V);var pt=m(V,2),j=l(pt),z=l(j);i(j);var ot=m(j,2),Zt=l(ot,!0);i(ot);var Dt=m(ot,2),Ut=l(Dt,!0);i(Dt),i(pt),i(X),et((L,Z,Y)=>{B(ht,e(A)||"Loading..."),B(wt,(M(r()),v(()=>r().green_agent_id||r().greenAgentId||"Unknown"))),Yt(j,"title",(M(r()),v(()=>r().battle_id||r().id))),B(z,`Battle #${L??""}`),B(Zt,Z),B(Ut,Y)},[()=>(M(r()),v(()=>T(r().battle_id||r().id))),()=>(M(r()),v(()=>q(r()))),()=>(M(r()),v(()=>F(ct(r()))))]),d(nt,X)},$$slots:{default:!0}});var _t=m(b,2);Qt(_t,{class:"pt-4 flex flex-row items-between justify-between w-full mb-0 px-2",children:(nt,Lt)=>{var X=me(),V=N(X),E=l(V),ht=l(E,!0);i(E);var J=m(E,2),wt=l(J,!0);i(J);var yt=m(J,2);{var bt=j=>{var z=ge(),ot=l(z);i(z),et(()=>B(ot,`Duration: ${e(U)??""}`)),d(j,z)};D(yt,j=>{M(r()),v(()=>r().result&&r().result.finish_time)&&j(bt)})}i(V);var vt=m(V,2),pt=l(vt);i(vt),et((j,z)=>{te(E,1,`text-xs font-semibold ${j??""}`),B(ht,(M(r()),v(()=>r().state))),B(wt,z),B(pt,`Battle ID: ${M(r()),v(()=>r().battle_id||r().id)??""}`)},[()=>(M(r()),v(()=>at(r().state))),()=>(M(r()),v(()=>mt(r())))]),d(nt,X)},$$slots:{default:!0}}),d(_,x)},$$slots:{default:!0}})};D(f,y=>{r()&&y(h)},!0)}d(n,o)};D(u,n=>{e(rt)?n(w):n(s,!1)},!0)}d(t,a)};D(ut,t=>{e(K)?t(ft):t(xt,!1)})}d(P,st),Et()}function we(P,p){k(p,e(p)+3)}function ye(P,p){k(p,e(p)+10)}var be=()=>R("/battles/stage-battle"),$e=(P,p)=>R(`/battles/${e(p).battle_id}`),ke=(P,p)=>P.key==="Enter"&&R(`/battles/${e(p).battle_id}`),Pe=g('<button type="button" class="cursor-pointer w-full"><!></button>'),Te=g('<button type="button" class="mt-2 px-4 py-2 rounded bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium">View More</button>'),Be=g('<div class="w-full max-w-4xl flex flex-col items-center"><h2 class="text-2xl font-bold text-center mb-10 mt-10">Ongoing Battles</h2> <div class="flex flex-col gap-4 w-full"><!> <!></div></div>'),De=(P,p)=>R(`/battles/${e(p).battle_id}`),Me=(P,p)=>P.key==="Enter"&&R(`/battles/${e(p).battle_id}`),Ae=g('<button type="button" class="cursor-pointer w-full"><!></button>'),je=g('<button type="button" class="mt-2 px-4 py-2 rounded bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium">View More</button>'),Se=g('<div class="w-full max-w-4xl flex flex-col items-center"><h2 class="text-2xl font-bold text-center mb-8 mt-8">Past Battles</h2> <div class="flex flex-col gap-4 w-full"><!> <!></div></div>'),Ce=g('<div class="text-center text-muted-foreground">No battles found.</div>'),Ie=g('<div class="w-full flex flex-col items-center justify-center mt-10 mb-8"><h1 class="text-2xl font-bold text-center mb-8">Battles</h1> <button type="button" class="flex items-center gap-2 px-5 py-2 rounded-md bg-primary text-primary-foreground text-base font-semibold shadow hover:bg-primary/90 transition cursor-pointer">Stage a Battle</button></div> <div class="flex flex-1 flex-col items-center justify-center min-h-[80vh] w-full"><div class="flex flex-1 flex-col gap-2 items-center justify-center w-full"><div class="flex flex-col gap-10 py-4 md:gap-12 md:py-6 w-full items-center justify-center"><!> <!> <!></div></div></div>',1);function Ke(P,p){Ot(p,!1);const[r,dt]=Ht(),K=()=>Rt(ae,"$loading",r);let A=Bt(p,"data",8)().battles,C=null,U=null;function W(){const s=["pending","queued","running"],n=["finished","error"];k($,A.filter(f=>s.includes((f.state||"").toLowerCase()))),k(T,A.filter(f=>n.includes((f.state||"").toLowerCase())));const o=new Set(e(T).map(f=>f.battle_id));k($,e($).filter(f=>!o.has(f.battle_id))),e($).sort((f,h)=>{const y=new Date(f.created_at||0).getTime();return new Date(h.created_at||0).getTime()-y}),e(T).sort((f,h)=>{function y(_){var b;let c=((b=_.result)==null?void 0:b.finish_time)||_.created_at||0;typeof c=="string"&&c&&!c.endsWith("Z")&&(c=c+"Z");const x=new Date(c).getTime();return isNaN(x)?0:x}return y(h)-y(f)})}Nt(async()=>{const{data:{session:s}}=await ee.auth.getSession();if(!s){console.log("Battles page: No session found, redirecting to login"),R("/login");return}U=re.subscribe(n=>{!n&&!K()&&(console.log("Battles page: User logged out, redirecting to login"),R("/login"))}),W(),C=new WebSocket((window.location.protocol==="https:"?"wss://":"ws://")+window.location.host+"/ws/battles"),C.onmessage=n=>{try{const o=JSON.parse(n.data);if(o&&o.type==="battles_update"&&Array.isArray(o.battles)&&(A=o.battles,W()),o&&o.type==="battle_update"&&o.battle){const f=A.findIndex(h=>h.battle_id===o.battle.battle_id);f!==-1?A[f]=o.battle:A=[o.battle,...A],W()}}catch(o){console.error("[WS] JSON parse error",o)}}}),zt(()=>{C&&C.close(),U&&U()});let $=O([]),T=O([]),F=O(3),q=O(10);It();var ct=Ie(),at=N(ct),mt=m(l(at),2);mt.__click=[be],i(at);var Q=m(at,2),st=l(Q),ut=l(st),ft=l(ut);{var xt=s=>{var n=Be(),o=m(l(n),2),f=l(o);Tt(f,1,()=>(e($),e(F),v(()=>e($).slice(0,e(F)))),_=>_.battle_id,(_,c)=>{var x=Pe();x.__click=[$e,c],x.__keydown=[ke,c];var b=l(x);Xt(b,{get battleId(){return e(c),v(()=>e(c).battle_id)}}),i(x),d(_,x)});var h=m(f,2);{var y=_=>{var c=Te();c.__click=[we,F],d(_,c)};D(h,_=>{e($),e(F),v(()=>e($).length>e(F))&&_(y)})}i(o),i(n),d(s,n)};D(ft,s=>{e($),v(()=>e($).length>0)&&s(xt)})}var t=m(ft,2);{var a=s=>{var n=Se(),o=m(l(n),2),f=l(o);Tt(f,1,()=>(e(T),e(q),v(()=>e(T).slice(0,e(q)))),_=>_.battle_id,(_,c)=>{var x=Ae();x.__click=[De,c],x.__keydown=[Me,c];var b=l(x);he(b,{get battleId(){return e(c),v(()=>e(c).battle_id)}}),i(x),d(_,x)});var h=m(f,2);{var y=_=>{var c=je();c.__click=[ye,q],d(_,c)};D(h,_=>{e(T),e(q),v(()=>e(T).length>e(q))&&_(y)})}i(o),i(n),d(s,n)};D(t,s=>{e(T),v(()=>e(T).length>0)&&s(a)})}var u=m(t,2);{var w=s=>{var n=Ce();d(s,n)};D(u,s=>{e($),e(T),v(()=>e($).length===0&&e(T).length===0)&&s(w)})}i(ut),i(st),i(Q),d(P,ct),Et(),dt()}Gt(["click","keydown"]);export{Ke as component,Re as universal};
