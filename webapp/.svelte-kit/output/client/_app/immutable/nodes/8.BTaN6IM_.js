import"../chunks/CWj6FrbW.js";import{i as Ee}from"../chunks/_pPX3X5k.js";import{o as Fe,a as Ge}from"../chunks/B-G1-8zH.js";import{p as Ie,v as Je,w as Le,f as h,a as _,b as Pe,j as b,m as S,i as e,c as o,r as s,l as ne,d as Z,k as N,q as u,s as l,x as d}from"../chunks/D_E79TID.js";import{i as y,s as He,a as Ue}from"../chunks/D0mllNP8.js";import{e as ze}from"../chunks/CqRAOBwW.js";import{s as Ke}from"../chunks/BMrKUOY7.js";import{p as Qe}from"../chunks/8ck2J7Fk.js";var Te=h("<div>Loading...</div>"),Ve=h('<div class="text-red-500"> </div>'),Xe=h('<div class="text-green-700">Winner: <span class="font-mono"> </span></div>'),Ye=h('<div class="text-red-700">Error: <span class="font-mono"> </span></div>'),Ze=h('<span class="text-xs font-bold text-green-700 ml-2">Result</span>'),Be=h('<pre class="text-xs bg-muted p-2 rounded overflow-x-auto mt-1"> </pre>'),et=h('<div class="text-xs text-green-700 mt-1">Winner: <span class="font-mono"> </span></div>'),tt=h('<div><div class="flex flex-row justify-between items-center mb-1"><span class="font-mono text-xs text-muted-foreground"> </span> <span class="text-xs px-2 py-0.5 rounded bg-muted text-muted-foreground"> </span> <!></div> <div class="text-sm font-medium mb-1"> </div> <!> <!></div>'),at=h('<div class="flex flex-col gap-3 mt-6"><h2 class="text-lg font-semibold mb-2">Interact History</h2> <!></div>'),rt=h('<div class="mb-8 space-y-2 border-b pb-4"><h1 class="text-2xl font-bold"> </h1> <div class="text-sm text-muted-foreground font-mono break-all"> </div> <div class="text-sm text-muted-foreground">State: <span class="font-mono"> </span></div> <div class="text-sm text-muted-foreground">Green Agent: <span class="font-mono"> </span></div> <div class="text-sm text-muted-foreground">Opponents: <span class="font-mono"> </span></div> <!> <!></div> <!>',1),ot=h('<main class="p-4 flex flex-col min-h-[60vh] max-w-xl mx-auto"><!></main>');function mt(ie,le){Ie(le,!1);const[de,ve]=He(),B=()=>Ue(Qe,"$page",de),O=S();let t=S(null),E=S(!0),j=S(""),M=S(""),W=S([]),k=null,F=null,G=new Map;async function R(r){var v,g,p,x;try{const a=await fetch(`/api/agents/${r}`);if(!a.ok)return r;const i=await a.json();return((v=i.register_info)==null?void 0:v.name)||((g=i.registerInfo)==null?void 0:g.name)||((p=i.agent_card)==null?void 0:p.name)||((x=i.agentCard)==null?void 0:x.name)||r}catch{return r}}async function ce(r){try{const v=await fetch(`/api/agents/${r}`);return v.ok?await v.json():null}catch{return null}}function pe(r,v){var x;const g=new Map;if(!((x=r.register_info)!=null&&x.participant_requirements)||!Array.isArray(v))return g;const p=r.register_info.participant_requirements;for(const a of v){const i=p.find(q=>q.name===a.name);i&&i.role&&g.set(a.name,i.role)}for(const a of p)if(a.name&&a.role){g.set(a.name,a.role);const i=a.name.split(" (")[0].trim();i!==a.name&&g.set(i,a.role)}return g}function me(r){if(r==="system")return"bg-gray-50 border-gray-200";if(r==="green_agent")return"bg-green-50 border-green-200";if(G.has(r)){const v=G.get(r);if(v==="blue_agent")return"bg-blue-50 border-blue-200";if(v==="red_agent")return"bg-red-50 border-red-200"}return"bg-yellow-50 border-yellow-200"}Fe(async()=>{b(E,!0),b(j,"");try{const r=await fetch(`/api/battles/${e(O)}`);if(!r.ok){b(j,"Failed to load battle");return}b(t,await r.json()),e(t).green_agent_id&&(b(M,await R(e(t).green_agent_id)),F=await ce(e(t).green_agent_id)),e(t).opponents&&Array.isArray(e(t).opponents)&&(b(W,await Promise.all(e(t).opponents.map(async p=>`${await R(p.agent_id)} (${p.name})`))),F&&(G=pe(F,e(t).opponents)));const g=`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}/ws/battles`;k=new WebSocket(g),k.onopen=()=>{console.log("Connected to battles WebSocket")},k.onmessage=p=>{const x=JSON.parse(p.data);x.type==="battle_update"&&x.battle.battle_id===e(O)&&(b(t,x.battle),e(t).green_agent_id&&!e(M)&&R(e(t).green_agent_id).then(a=>b(M,a)),e(t).opponents&&Array.isArray(e(t).opponents)&&Promise.all(e(t).opponents.map(async a=>`${await R(a.agent_id)} (${a.name})`)).then(a=>b(W,a)))},k.onerror=p=>{console.error("WebSocket error:",p)},k.onclose=()=>{console.log("WebSocket connection closed")}}catch(r){b(j,"Failed to load battle"),console.error(r)}finally{b(E,!1)}}),Ge(()=>{k&&k.close()}),Je(()=>B(),()=>{b(O,B().params.battle_id)}),Le(),Ee();var I=ot(),fe=o(I);{var _e=r=>{var v=Te();_(r,v)},ue=r=>{var v=ne(),g=Z(v);{var p=a=>{var i=Ve(),q=o(i,!0);s(i),N(()=>u(q,e(j))),_(a,i)},x=a=>{var i=ne(),q=Z(i);{var ge=J=>{var ee=rt(),L=Z(ee),P=o(L),xe=o(P);s(P);var H=l(P,2),be=o(H);s(H);var U=l(H,2),te=l(o(U)),we=o(te,!0);s(te),s(U);var z=l(U,2),ae=l(o(z)),he=o(ae,!0);s(ae),s(z);var K=l(z,2),re=l(o(K)),ye=o(re,!0);s(re),s(K);var oe=l(K,2);{var $e=c=>{var m=Xe(),A=l(o(m)),$=o(A,!0);s(A),s(m),N(()=>u($,(e(t),d(()=>e(t).result.winner)))),_(c,m)};y(oe,c=>{e(t),d(()=>e(t).result&&e(t).state==="finished")&&c($e)})}var ke=l(oe,2);{var Ae=c=>{var m=Ye(),A=l(o(m)),$=o(A,!0);s(A),s(m),N(()=>u($,(e(t),d(()=>e(t).error)))),_(c,m)};y(ke,c=>{e(t),d(()=>e(t).error&&e(t).state==="error")&&c(Ae)})}s(L);var Ne=l(L,2);{var Se=c=>{var m=at(),A=l(o(m),2);ze(A,3,()=>(e(t),d(()=>e(t).interact_history)),($,n)=>$.timestamp+$.message+n,($,n)=>{var C=tt(),Q=o(C),T=o(Q),je=o(T,!0);s(T);var V=l(T,2),qe=o(V,!0);s(V);var Me=l(V,2);{var We=f=>{var w=Ze();_(f,w)};y(Me,f=>{e(n),d(()=>e(n).is_result)&&f(We)})}s(Q);var X=l(Q,2),Re=o(X,!0);s(X);var se=l(X,2);{var Ce=f=>{var w=Be(),D=o(w,!0);s(w),N(Y=>u(D,Y),[()=>(e(n),d(()=>JSON.stringify(e(n).detail,null,2)))]),_(f,w)};y(se,f=>{e(n),d(()=>e(n).detail)&&f(Ce)})}var De=l(se,2);{var Oe=f=>{var w=et(),D=l(o(w)),Y=o(D,!0);s(D),s(w),N(()=>u(Y,(e(n),d(()=>e(n).winner)))),_(f,w)};y(De,f=>{e(n),d(()=>e(n).winner)&&f(Oe)})}s(C),N((f,w)=>{Ke(C,1,`border rounded-lg p-3 ${f??""}`),u(je,w),u(qe,(e(n),d(()=>e(n).reported_by))),u(Re,(e(n),d(()=>e(n).message)))},[()=>(e(n),d(()=>me(e(n).reported_by))),()=>(e(n),d(()=>new Date(e(n).timestamp).toLocaleString()))]),_($,C)}),s(m),_(c,m)};y(Ne,c=>{e(t),d(()=>e(t).interact_history&&e(t).interact_history.length>0)&&c(Se)})}N((c,m)=>{u(xe,`Battle #${c??""}`),u(be,`ID: ${e(t),d(()=>e(t).battle_id)??""}`),u(we,(e(t),d(()=>e(t).state))),u(he,e(M)),u(ye,m)},[()=>(e(t),d(()=>{var c;return(c=e(t).battle_id)==null?void 0:c.slice(0,8)})),()=>(e(W),d(()=>e(W).join(", ")))]),_(J,ee)};y(q,J=>{e(t)&&J(ge)},!0)}_(a,i)};y(g,a=>{e(j)?a(p):a(x,!1)},!0)}_(r,v)};y(fe,r=>{e(E)?r(_e):r(ue,!1)})}s(I),_(ie,I),Pe(),ve()}export{mt as component};
